/* -------------------------------------------------------------------------- */
/* 1. CSS CUSTOM PROPERTIES ENGINE (@property)                                */
/* -------------------------------------------------------------------------- */
@property --ion-x { syntax: '<number>'; inherits: true; initial-value: 0; }
@property --ion-y { syntax: '<number>'; inherits: true; initial-value: 0; }
@property --warp-scale { syntax: '<number>'; inherits: true; initial-value: 0.92; }
@property --ion-glow { syntax: '<length>'; inherits: true; initial-value: 700px; }
@property --chroma-dist { syntax: '<number>'; inherits: true; initial-value: 0; }

:root {
  /* --- COLOR SYSTEM (Semantic) --- */
  color-scheme: light dark;
  --bg: light-dark(#f8fafc, #020617);
  --bg-dark: #020617;
  --text-main: light-dark(#0f172a, #f1f5f9);
  --text-muted: light-dark(#475569, #64748b);
  --border: light-dark(#e2e8f0, #1e293b);
  --cell-bg: light-dark(#ffffff, #020617);

  /* --- INTERACTIVE STATES --- */
  /* Hover States */
  --hover-bg: light-dark(rgba(67, 56, 202, 0.08), rgba(251, 191, 36, 0.12));
  --hover-border: light-dark(rgba(67, 56, 202, 0.3), rgba(251, 191, 36, 0.4));
  --hover-text: light-dark(#4338ca, #fbbf24);
  --hover-scale: 1.02;
  --hover-opacity: 0.9;

  /* Active States */
  --active-bg: light-dark(rgba(67, 56, 202, 0.15), rgba(251, 191, 36, 0.2));
  --active-border: light-dark(rgba(67, 56, 202, 0.5), rgba(251, 191, 36, 0.6));
  --active-text: light-dark(#312e81, #f59e0b);
  --active-scale: 0.98;

  /* Focus States */
  --focus-ring: light-dark(rgba(67, 56, 202, 0.4), rgba(251, 191, 36, 0.5));
  --focus-ring-width: 2px;
  --focus-outline-offset: 2px;

  /* --- ACCENTS --- */
  --accent-primary: light-dark(#4338ca, #fbbf24);
  --accent-secondary: light-dark(#0369a1, #22d3ee);
  --today-glow: light-dark(rgba(67, 56, 202, 0.3), rgba(59, 130, 246, 0.6));
  --today-gradient-start: #2563eb;
  --today-gradient-end: #1e40af;

  /* --- PRIMITIVES (Fixed Colors) --- */
  --white: #ffffff;
  --white-20: rgba(255, 255, 255, 0.2);
  --white-90: rgba(255, 255, 255, 0.9);
  --black: #000000;
  --black-30: rgba(0, 0, 0, 0.3);
  --black-60: rgba(0, 0, 0, 0.6);
  --chroma-red: rgba(255, 0, 0, 0.2);
  --chroma-cyan: rgba(0, 255, 255, 0.2);

  /* --- OVERLAYS & GLASSMORPHISM --- */
  --cyan-overlay: light-dark(rgba(34, 211, 238, 0.03), rgba(34, 211, 238, 0.06));
  --cyan-overlay-strong: light-dark(rgba(34, 211, 238, 0.08), rgba(34, 211, 238, 0.12));
  --cyan-overlay-border: light-dark(rgba(34, 211, 238, 0.2), rgba(34, 211, 238, 0.35));
  --cyan-overlay-border-strong: light-dark(rgba(34, 211, 238, 0.3), rgba(34, 211, 238, 0.5));
  --amber-overlay: light-dark(rgba(251, 191, 36, 0.05), rgba(251, 191, 36, 0.1));
  --toast-bg: light-dark(rgba(15, 23, 42, 0.82), rgba(2, 6, 23, 0.65));
  --watermark-stroke: light-dark(rgba(148, 163, 184, 0.1), rgba(148, 163, 184, 0.15));

  /* Glassmorphism Utilities */
  --glass-bg: light-dark(rgba(255, 255, 255, 0.1), rgba(15, 23, 42, 0.3));
  --glass-bg-strong: light-dark(rgba(255, 255, 255, 0.15), rgba(15, 23, 42, 0.4));
  --glass-border: light-dark(rgba(255, 255, 255, 0.2), rgba(148, 163, 184, 0.2));
  --glass-blur: var(--blur-medium);
  --glass-blur-strong: var(--blur-strong);
  --glass-saturate: 180%;
  --glass-backdrop: blur(var(--glass-blur)) saturate(var(--glass-saturate));
  --glass-backdrop-strong: blur(var(--glass-blur-strong)) saturate(var(--glass-saturate));

  /* --- ION DRIVE SYSTEM --- */
  --ion-primary: var(--accent-primary);
  --ion-secondary: var(--accent-secondary);
  --ion-blend: light-dark(multiply, screen);
  --ion-opacity: light-dark(0.4, 0.85);
  --ion-core-radius: 50px;
  --dust-opacity: light-dark(0.04, 0.12);

  /* --- SPACING SYSTEM --- */
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 12px;
  --space-lg: 20px;
  --space-xl: 28px;
  --space-2xl: 30px;
  --space-3xl: 40px;

  /* --- TYPOGRAPHY --- */
  /* Font Sizes */
  --font-micro: 6px;
  --font-tiny: 8px;
  --font-xs: 10px;
  --font-sm: 14px;
  --font-lg: 22px;
  --font-watermark-min: 100px;
  --font-watermark-max: 400px;
  --font-info-meta-dvh: 0.8dvh;

  /* Font Weights (Space Grotesk) */
  --font-weight-light: 300;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;
  --font-weight-extrabold: 800;
  --font-weight-black: 900;

  /* Line Heights */
  --line-height-tight: 1;
  --line-height-normal: 1.2;
  --line-height-relaxed: 1.5;
  --line-height-loose: 1.8;

  /* Letter Spacing */
  --letter-spacing-small: 0.1em;
  --letter-spacing-medium: 0.15em;
  --letter-spacing-wide: 0.5em;
  --letter-spacing-wider: 0.25em;
  --text-transform-uppercase: uppercase;

  /* --- RESPONSIVE BREAKPOINTS --- */
  /*
   * Usage in media queries:
   * @media (min-width: 640px) { ... }  // sm
   * @media (min-width: 768px) { ... }  // md
   * @media (min-width: 1024px) { ... } // lg
   *
   * Note: CSS variables cannot be used directly in media queries,
   * but these values serve as reference for consistent breakpoints.
   */
  --breakpoint-xs: 320px;
  --breakpoint-sm: 640px;
  --breakpoint-md: 768px;
  --breakpoint-lg: 1024px;
  --breakpoint-xl: 1280px;
  --breakpoint-2xl: 1536px;
  --breakpoint-3xl: 1920px;

  /* --- ELEVATION (Z-INDEX) --- */
  /*
   * Z-INDEX LAYERING MAP (Visual Hierarchy)
   *
   * ┌─────────────────────────────────────────┐
   * │ 100000  Loading Screen (topmost)       │
   * ├─────────────────────────────────────────┤
   * │ 99999   Toast Notifications            │
   * ├─────────────────────────────────────────┤
   * │ 9999    Theme Veil (transition overlay) │
   * ├─────────────────────────────────────────┤
   * │ 10      Watermark, Today Cell          │
   * ├─────────────────────────────────────────┤
   * │ 6       Atmosphere (noise layer)        │
   * ├─────────────────────────────────────────┤
   * │ 5       Ion Drive (cursor effect)      │
   * ├─────────────────────────────────────────┤
   * │ 3       Cell Effects (week/month)      │
   * ├─────────────────────────────────────────┤
   * │ 2       Grid Layer (base)               │
   * └─────────────────────────────────────────┘
   */
  --z-grid: 2;
  --z-cell-effect: 3;
  --z-ion: 5;
  --z-atmosphere: 6;
  --z-watermark: 10;
  --z-cell-today: 10;
  --z-theme-veil: 9999;
  --z-toast: 99999;
  --z-loading: 100000;

  /* --- MOTION & ANIMATION --- */
  --duration-fast: 0.3s;
  --duration-medium: 0.4s;
  --duration-normal: 0.5s;
  --duration-slow: 0.6s;
  --duration-slower: 0.8s;
  --duration-slowest: 1s;
  --duration-smooth: 1.2s;
  --duration-very-slow: 1.5s;
  --duration-ultra-slow: 1.8s;
  --duration-drift: 60s;
  --drift-duration: 30s;
  --drift-distance: 200px;

  --ease-smooth: cubic-bezier(0.16, 1, 0.3, 1);
  --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
  --ease-warp: cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --ease-snap: cubic-bezier(0.19, 1, 0.22, 1);

  /* --- EFFECTS & TRANSFORMS --- */
  --blur-none: 0px;
  --blur-inactive: 6px;
  --blur-subtle: 10px;
  --blur-medium: 20px;
  --blur-strong: 40px;
  --blur-extreme: 100px;

  --scale-inactive: 0.8;
  --scale-active: 1;
  --scale-warp-far: 1.4;
  --scale-warp-near: 1.05;

  --translate-z-inactive: -600px;
  --translate-z-active: 0px;

  --opacity-hidden: 0;
  --opacity-subtle: 0.08;
  --opacity-faint: 0.15;
  --opacity-light: 0.2;
  --opacity-medium: 0.3;
  --opacity-half: 0.5;
  --opacity-visible: 1;

  --warp-saturate-boost: 2;
  --brightness-warp: 1.5;
  --contrast-warp: 1.2;
  --saturate-toast: 180%;

  /* --- SHADOWS --- */
  --shadow-today: 0 10px 30px -5px var(--today-glow);
  --shadow-toast: 0 15px 40px var(--black-60);
  --glow-text-today: 0 2px 10px var(--black-30);

  /* --- MISC / LAYOUT --- */
  --perspective: 2000px;
  --border-width: 0.5px;
  --border-width-strong: 1px;
  --border-width-medium: 2px;
  --border-radius-pill: 40px;
  --grid-width: 100.1%;
  --grid-offset: -0.5px;
  --watermark-offset-x: 5%;
  --gradient-watermark: linear-gradient(180deg, var(--accent-primary), var(--accent-secondary), transparent);
  --gradient-angle-week-start: 135deg;
  --gradient-angle-month-start: 180deg;

  --loader-width: 150px;
  --loader-height: 1px;
  --loader-track: light-dark(#e2e8f0, rgba(34, 211, 238, 0.2));
  --skeleton-width: 40%;

  --reduced-motion-duration: 0.01ms;
  --reduced-motion-iteration-count: 1;
}

/* -------------------------------------------------------------------------- */
/* 2. BASE RESET                                                              */
/* -------------------------------------------------------------------------- */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

html, body {
  height: 100dvh;
  width: 100vw;
  background: var(--bg);
  color: var(--text-main);
  font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif;
  overflow: hidden;
  perspective: var(--perspective);
  overscroll-behavior: none;
  contain: strict;
}

/* -------------------------------------------------------------------------- */
/* 3. LAYOUT & SYSTEM COMPONENTS                                              */
/* -------------------------------------------------------------------------- */

/* ION DRIVE EFFECT */
#ion-drive {
  position: fixed;
  inset: 0;
  z-index: var(--z-ion);
  pointer-events: none;
  background:
    radial-gradient(
      var(--ion-glow) circle at calc(var(--ion-x) * 1px) calc(var(--ion-y) * 1px),
      color-mix(in srgb, var(--ion-secondary) 15%, transparent) 0%,
      transparent 60%
    ),
    radial-gradient(
      var(--ion-core-radius) circle at calc(var(--ion-x) * 1px) calc(var(--ion-y) * 1px),
      color-mix(in srgb, var(--ion-primary) 60%, transparent) 0%,
      transparent 100%
    );
  opacity: var(--ion-opacity);
  mix-blend-mode: var(--ion-blend);
  transition:
    opacity var(--duration-normal) var(--ease-smooth),
    background var(--duration-fast) var(--ease-smooth),
    --ion-glow var(--duration-slow) var(--ease-warp);
  will-change: transform;
  transform: translateZ(0);
}

#ion-drive.jumping {
  opacity: var(--opacity-hidden) !important;
  transform: scale(var(--opacity-hidden)) translateZ(var(--translate-z-active));
  transition: opacity var(--duration-medium) ease-out, transform var(--duration-slow) var(--ease-snap);
}

/* ATMOSPHERE / NOISE EFFECT */
#atmosphere {
  position: fixed;
  inset: 0;
  z-index: var(--z-atmosphere);
  pointer-events: none;
  opacity: var(--dust-opacity);
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  mix-blend-mode: overlay;
  animation: drift var(--drift-duration) linear infinite;
}

@keyframes drift {
  from { background-position: 0 0; }
  to { background-position: var(--drift-distance) var(--drift-distance); }
}

/* LOADING SCREEN */
#loading-screen {
  position: fixed;
  inset: 0;
  z-index: var(--z-loading);
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: opacity var(--duration-slow) ease-out, visibility var(--duration-slow);
}

#loading-screen.hidden {
  opacity: 0;
  visibility: hidden;
}

.loader-text {
  color: var(--accent-secondary);
  font-size: var(--font-xs);
  letter-spacing: var(--letter-spacing-wide);
  text-transform: var(--text-transform-uppercase);
  font-weight: var(--font-weight-black);
  margin-top: var(--space-lg);
  text-align: center;
}

.loader-bar {
  width: var(--loader-width);
  height: var(--loader-height);
  background: var(--loader-track);
  position: relative;
  overflow: hidden;
}

.loader-progress {
  position: absolute;
  height: 100%;
  width: var(--opacity-hidden);
  background: var(--accent-secondary);
}

/* VIEWPORT & CANVAS */
#viewport {
  width: 100vw;
  height: 100dvh;
  overflow-y: auto;
  scroll-snap-type: y mandatory;
  scrollbar-width: none;
  position: relative;
  -webkit-overflow-scrolling: touch;
}

#viewport.is-locked {
  pointer-events: none !important;
}

#viewport.warping-far .year-block {
  filter: blur(var(--blur-extreme)) saturate(var(--warp-saturate-boost));
  opacity: var(--opacity-hidden);
  transition: all var(--duration-slower) var(--ease-smooth);
}

#viewport.warping-far #infinite-canvas {
  transform: scale(var(--scale-warp-far)) translateZ(var(--translate-z-active));
  filter: blur(var(--blur-strong)) brightness(var(--brightness-warp)) contrast(var(--contrast-warp));
  transition: transform var(--duration-ultra-slow) var(--ease-smooth), filter var(--duration-smooth) ease-in-out;
  opacity: var(--opacity-medium);
}

#viewport.warping-near #infinite-canvas {
  transform: scale(var(--scale-warp-near)) translateZ(var(--translate-z-active));
  filter: blur(var(--blur-subtle));
  transition: transform var(--duration-smooth) ease-out, filter var(--duration-slower) ease-out;
}

#infinite-canvas {
  position: relative;
  width: 100%;
  contain: layout;
}

/* YEAR BLOCK */
.year-block {
  position: absolute;
  left: 0;
  width: 100vw;
  height: 100dvh;
  scroll-snap-align: start;
  scroll-snap-stop: always;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  content-visibility: auto;
  contain-intrinsic-size: 100vw 100dvh;
  backface-visibility: hidden;
  transform: translateZ(0);
  transform-origin: center center;
  transition: transform var(--duration-slowest) var(--ease-smooth), filter var(--duration-slowest) ease,
    opacity var(--duration-slower) ease;
  will-change: transform, opacity, filter;
  contain: strict;
}

.year-block:not(.active) {
  transform: scale(var(--scale-inactive)) translate3d(0, 0, var(--translate-z-inactive));
  filter: blur(var(--blur-inactive)) grayscale(var(--opacity-half));
  opacity: var(--opacity-faint);
}

.year-block:not(.active) .date-num {
  background: var(--text-muted);
  color: transparent !important;
  height: var(--loader-height);
  width: var(--skeleton-width);
  margin: var(--space-xs) auto;
  opacity: var(--opacity-half);
}

.year-block:not(.active) .info-meta {
  opacity: 0;
}

.year-block.active {
  transform: scale(var(--scale-active)) translate3d(0, 0, var(--translate-z-active));
  filter: blur(var(--blur-none));
  opacity: var(--opacity-visible);
}

/* GRID CONTAINER */
.grid-container {
  position: relative;
  flex: 1;
  display: flex;
  background: var(--bg);
  overflow-x: hidden;
  scrollbar-width: none;
  filter: drop-shadow(calc(var(--chroma-dist) * 1px) 0 0 var(--chroma-cyan));
  backface-visibility: hidden;
  transform: translateZ(0);
  will-change: transform;
}

.grid-layer {
  display: grid;
  width: var(--grid-width);
  margin-left: var(--grid-offset);
  min-height: 100%;
  opacity: var(--opacity-hidden);
  transition: opacity var(--duration-slower) ease;
  z-index: var(--z-grid);
  gap: 0;
  background: transparent;
}

.year-block.active .grid-layer {
  opacity: var(--opacity-visible);
}

/* WATERMARK */
.watermark-embedded {
  position: absolute;
  top: 0;
  right: var(--watermark-offset-x);
  height: 100%;
  display: flex;
  align-items: center;
  font-size: clamp(var(--font-watermark-min), 30dvh, var(--font-watermark-max));
  font-weight: var(--font-weight-black);
  color: transparent;
  background: var(--gradient-watermark);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-stroke: var(--border-width-strong) var(--watermark-stroke);
  writing-mode: vertical-rl;
  pointer-events: none;
  opacity: var(--opacity-hidden);
  z-index: var(--z-watermark);
  transition: opacity var(--duration-slowest), transform var(--duration-very-slow) var(--ease-smooth);
  will-change: transform;
}

.year-block.active .watermark-embedded {
  opacity: var(--opacity-faint);
  transform: translate3d(0, 0, var(--translate-z-active));
}

.year-block.is-scrolling .watermark-embedded {
  position: fixed;
  opacity: var(--opacity-subtle);
}

/* CELL */
.cell {
  background: var(--cell-bg);
  position: relative;
  box-shadow: inset 0 0 0 var(--border-width) var(--border);
  display: flex;
  flex-direction: column;
  transition: background var(--duration-medium) ease, opacity var(--duration-medium) ease;
  contain: content;
}

.cell.week-start {
  background: linear-gradient(var(--gradient-angle-week-start), var(--amber-overlay) 0%, transparent 100%);
}

.cell.week-start::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: var(--border-width-medium);
  background: linear-gradient(90deg, var(--accent-primary), transparent);
  opacity: var(--opacity-light);
  z-index: var(--z-cell-effect);
}

.cell.month-start {
  background: linear-gradient(var(--gradient-angle-month-start), var(--cyan-overlay-strong) 0%, transparent 100%);
  box-shadow: inset 0 var(--border-width-medium) 0 0 var(--accent-secondary),
    inset 0 0 0 var(--border-width) var(--border);
}

.cell.month-start .info-meta.top-label {
  color: var(--accent-secondary);
  font-weight: var(--font-weight-black);
  letter-spacing: var(--letter-spacing-medium);
}

.cell.today {
  background: linear-gradient(135deg, var(--today-gradient-start) 0%, var(--today-gradient-end) 100%);
  z-index: var(--z-cell-today);
  box-shadow: var(--shadow-today), inset 0 0 0 var(--border-width-strong) var(--white-20);
}

.cell.today .date-num {
  font-weight: var(--font-weight-black);
  color: var(--white) !important;
  text-shadow: var(--glow-text-today);
}

.cell.today .info-meta {
  color: var(--white-90);
  font-weight: var(--font-weight-bold);
}

.cell-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;
  padding: var(--space-sm) var(--space-xs);
  z-index: var(--z-grid);
  pointer-events: none;
}

.date-num {
  font-size: clamp(var(--font-sm), 2.5dvh, var(--font-lg));
  font-weight: var(--font-weight-light);
  line-height: var(--line-height-tight);
  color: var(--text-main);
  transition: color var(--duration-medium) ease, font-size var(--duration-medium) ease;
  will-change: color, font-size;
}

.info-meta {
  font-size: clamp(var(--font-micro), var(--font-info-meta-dvh), var(--font-tiny));
  text-transform: var(--text-transform-uppercase);
  font-weight: var(--font-weight-semibold);
  color: var(--text-muted);
  letter-spacing: var(--letter-spacing-small);
  transition: opacity var(--duration-medium) ease;
}

/* TOAST */
#toast {
  position: fixed;
  bottom: var(--space-2xl);
  left: 50%;
  transform: translateX(-50%) translateY(var(--space-lg));
  background: var(--toast-bg);
  color: var(--accent-secondary);
  backdrop-filter: var(--glass-backdrop);
  padding: var(--space-md) var(--space-xl);
  border-radius: var(--border-radius-pill);
  font-weight: var(--font-weight-black);
  font-size: var(--font-xs);
  z-index: var(--z-toast);
  opacity: var(--opacity-hidden);
  border: var(--border-width-strong) solid var(--cyan-overlay-border-strong);
  letter-spacing: var(--letter-spacing-wider);
  text-transform: var(--text-transform-uppercase);
  transition: opacity var(--duration-slow) var(--ease-bounce), transform var(--duration-slow) var(--ease-bounce);
  will-change: opacity, transform;
  pointer-events: none;
  box-shadow: var(--shadow-toast);
}

#toast.active {
  opacity: var(--opacity-visible);
  transform: translateX(-50%) translateY(var(--translate-z-active));
}

/* THEME VEIL */
#theme-veil {
  position: fixed;
  inset: 0;
  z-index: var(--z-theme-veil);
  background: var(--bg);
  pointer-events: none;
  opacity: var(--opacity-hidden);
  transition: opacity var(--duration-normal);
  will-change: opacity;
}

#theme-veil.active {
  opacity: var(--opacity-visible);
}

/* -------------------------------------------------------------------------- */
/* 4. ACCESSIBILITY & PERFORMANCE                                             */
/* -------------------------------------------------------------------------- */

/* POWER SAVE MODE */
:root.powersave {
  --duration-fast: 0s !important;
  --duration-medium: 0s !important;
  --duration-normal: 0s !important;
  --duration-slow: 0s !important;
  --duration-slower: 0s !important;
  --duration-slowest: 0s !important;
  --duration-smooth: 0s !important;
  --duration-very-slow: 0s !important;
  --duration-ultra-slow: 0s !important;
  --duration-drift: 0s !important;
  animation: none !important;
}

:root.powersave *,
:root.powersave *::before,
:root.powersave *::after {
  transition: none !important;
  animation: none !important;
}

/* REDUCED MOTION */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    transition-duration: var(--reduced-motion-duration) !important;
    animation-duration: var(--reduced-motion-duration) !important;
    animation-iteration-count: var(--reduced-motion-iteration-count) !important;
  }

  #atmosphere {
    animation: none !important;
  }

  .year-block:not(.active) {
    filter: none !important;
  }
}
